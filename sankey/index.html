<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
    <!-- Google fonts! -->
    <link href='http://fonts.googleapis.com/css?family=Bitter:400,700,400italic|Patua+One' rel='stylesheet' type='text/css'>

    <title>Sankey diagram fun - justmytwospence</title>
    
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="http://spencerboucher.com//favicon.ico" rel="icon">

    <!-- Open Graph tags -->
        <meta property="og:site_name" content="justmytwospence" />
            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Sankey diagram fun"/>
            <meta property="og:url" content="http://spencerboucher.com/sankey/"/>
            <meta property="og:description" content="Let&#39;s have some fun with some unconventional data munging and an unconventional data visualization technique, using our three favorite tools: Python, R, and D3."/>
            <meta property="article:published_time" content="2014-05-13" />
            <meta property="article:section" content="Python" />
            <meta property="article:tag" content="Python" />
            <meta property="article:tag" content="R" />
            <meta property="article:tag" content="Sankey diagram" />
            <meta property="article:tag" content="Pandas" />
            <meta property="article:tag" content="NetworkX" />
            <meta property="article:tag" content="D3.js" />

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://spencerboucher.com/theme/css/bootstrap.solarizedlight.min.css" type="text/css"/>
    <link href="http://spencerboucher.com/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://spencerboucher.com/theme/css/pygments/solarizeddark.css" rel="stylesheet">
        <link href="http://spencerboucher.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://spencerboucher.com/theme/css/style.css" type="text/css"/>

        <link href="http://spencerboucher.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="justmytwospence ATOM Feed"/>

<!-- MathJax script -->
<script src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
<script type="text/javascript">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            },
            displayAlign: 'center', // Change this to 'center' to center equations.
            "HTML-CSS": {
                styles: {'.MathJax_Display': {"margin": 0}}
            }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    }
}
init_mathjax();
</script>
    <link rel="stylesheet" href="/theme/css/knitr.css" type="text/css"/>
    <script src="http://spencerboucher.com/theme/js/knitr.js" type="text/javascript"></script> 

    <link rel="stylesheet" href="http://spencerboucher.com/theme/css/ipythonnb.css" type="test/css"/>


</head>

<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://spencerboucher.com/" class="navbar-brand">
justmytwospence            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://spencerboucher.com/about/">
                             About
                          </a></li>
                         <li><a href="http://spencerboucher.com/map/">
                             <i class="fa fa-location-arrow fa-lg"></i>
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://github.com/justmytwospence">
                        <i class="fa fa-github-square fa-lg"></i><span class="icon-label">GitHub</span>
                    </a></li>
                    <li><a href="http://linkedin.com/in/spencerboucher">
                        <i class="fa fa-linkedin-square fa-lg"></i><span class="icon-label">LinkedIn</span>
                    </a></li>
                    <li><a href="feeds/all.atom.xml">
                        <i class="fa fa-rss-square fa-lg"></i><span class="icon-label">RSS</span>
                    </a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
    <div class="col-lg-12">
        <section id="content">
            <article>
                <header class="page-header">
                    <h1>Sankey diagram&nbsp;fun</h1>
<footer class="post-info">
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-05-13T21:11:46"> Tue 13 May 2014</time>
    </span>


    <span class="Python">
        <i class="fa fa-folder-open"></i>
        <a href="http://spencerboucher.com/python">Python</a>
    </span>


	<span>
	<i class="fa fa-tag"></i>
		<a href="http://spencerboucher.com/tags/python/">Python</a>
	        /
		<a href="http://spencerboucher.com/tags/r/">R</a>
	        /
		<a href="http://spencerboucher.com/tags/sankey-diagram/">Sankey diagram</a>
	        /
		<a href="http://spencerboucher.com/tags/pandas/">Pandas</a>
	        /
		<a href="http://spencerboucher.com/tags/networkx/">NetworkX</a>
	        /
		<a href="http://spencerboucher.com/tags/d3js/">D3.js</a>

    
</footer><!-- /.post-info -->                </header>
                <div class="entry-content">
                    <p>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I&#39;m currently working on the final project for my data visualization course. The dataset that I&#39;ve chosen to work with can be <a href="http://snap.stanford.edu/data/web-Reddit.html">downloaded here</a> &#8212; it&#39;s a compendium Reddit resubmissions over a period of several years (ie, images that were submitted to more than one and/or to multiple subreddits). I waffled for a long time trying to decide what the best way to visualize the <em>flow</em> of images through various subreddits would be, but just in the nick of time, I stumbled across Christopher Gandrud&#39;s new <a href="http://christophergandrud.github.io/d3Network/">d3Network package for R</a>, and that was enough cause for me to settle on a Sankey diagram. If you&#39;ve never heard of Reddit, the illustrious <span class="caps">CPG</span> Grey will enlighten&nbsp;you.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[1]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s">&#39;tlI022aUWQQ&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">
    Out[1]:</div>

<div class="output_html rendered_html output_subarea output_pyout">

        <iframe
            width="400"
            height=300"
            src="https://www.youtube.com/embed/tlI022aUWQQ"
            frameborder="0"
            allowfullscreen
        ></iframe>
        
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The task of massaging columnar data consisting of an image <span class="caps">ID</span>, subreddit name, and timestamp for each submission into a more networky format suitable for this type of visualization was interesting enough that I thought it might be a good post. If nothing else, Christopher&#39;s awesome package deserves some&nbsp;love.</p>
<p>Python is my go-to language for data munging of this calibre, so we will use a Pandas -&gt; NetworkX -&gt; R -&gt; D3 worflow. Without further ado, lets load the Python modules we will need and take a look at the&nbsp;data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[2]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="c"># Load modules and data</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>                        <span class="c"># For reading/munging the data</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>                      <span class="c"># For creating a graph structure</span>
<span class="kn">from</span> <span class="nn">networkx.readwrite</span> <span class="kn">import</span> <span class="n">json_graph</span>  <span class="c"># For exporting a graph structure</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>               <span class="c"># For some more interesting munging</span>

<span class="o">%</span><span class="k">load_ext</span> <span class="n">rmagic</span>                           
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>           <span class="c"># To display results when we&#39;re done</span>

<span class="o">!</span>csvclean redditSubmissions.csv
<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">&#39;redditSubmissions_out.csv&#39;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>
6 errors logged to redditSubmissions_err.csv

</pre>
</div>
</div>

<div class="output_area"><div class="prompt output_prompt">
    Out[2]:</div>

<div class="output_html rendered_html output_subarea output_pyout">
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>#image_id</th>
      <th>unixtime</th>
      <th>rawtime</th>
      <th>title</th>
      <th>total_votes</th>
      <th>reddit_id</th>
      <th>number_of_upvotes</th>
      <th>subreddit</th>
      <th>number_of_downvotes</th>
      <th>localtime</th>
      <th>score</th>
      <th>number_of_comments</th>
      <th>username</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> 0</td>
      <td> 1333172439</td>
      <td> 2012-03-31T12:40:39.590113-07:00</td>
      <td>          And here&#8217;s a downvote.</td>
      <td> 63470</td>
      <td> rmqjs</td>
      <td> 32657</td>
      <td>    funny</td>
      <td> 30813</td>
      <td> 1333197639</td>
      <td> 1844</td>
      <td> 622</td>
      <td> Animates_Everything</td>
    </tr>
    <tr>
      <th>1</th>
      <td> 0</td>
      <td> 1333178161</td>
      <td> 2012-03-31T14:16:01.093638-07:00</td>
      <td>                     Expectation</td>
      <td>    35</td>
      <td> rmun4</td>
      <td>    29</td>
      <td> GifSound</td>
      <td>     6</td>
      <td> 1333203361</td>
      <td>   23</td>
      <td>   3</td>
      <td>       Gangsta_Raper</td>
    </tr>
    <tr>
      <th>2</th>
      <td> 0</td>
      <td> 1333199913</td>
      <td> 2012-03-31T20:18:33.192906-07:00</td>
      <td>                        Downvote</td>
      <td>    41</td>
      <td> rna86</td>
      <td>    32</td>
      <td> GifSound</td>
      <td>     9</td>
      <td> 1333225113</td>
      <td>   23</td>
      <td>   0</td>
      <td>       Gangsta_Raper</td>
    </tr>
    <tr>
      <th>3</th>
      <td> 0</td>
      <td> 1333252330</td>
      <td>        2012-04-01T10:52:10-07:00</td>
      <td> Every time I downvote something</td>
      <td>    10</td>
      <td> ro7e4</td>
      <td>     6</td>
      <td> GifSound</td>
      <td>     4</td>
      <td> 1333277530</td>
      <td>    2</td>
      <td>   0</td>
      <td>       Gangsta_Raper</td>
    </tr>
    <tr>
      <th>4</th>
      <td> 0</td>
      <td> 1333272954</td>
      <td> 2012-04-01T16:35:54.393381-07:00</td>
      <td>  Downvote &amp;quot;Dies Irae&amp;quot;</td>
      <td>    65</td>
      <td> rooof</td>
      <td>    57</td>
      <td> GifSound</td>
      <td>     8</td>
      <td> 1333298154</td>
      <td>   49</td>
      <td>   0</td>
      <td>       Gangsta_Raper</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 13&nbsp;columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that I first called <code>csvclean</code>, from the <a href="http://csvkit.readthedocs.org/en/latest/index.html">csvkit suite of command line utilities</a>. The bang (!) symbol calls the command line from IPython. <code>csvclean</code> fixes a couple of formatting errors in the original dataset that interfere with R/Panda&#39;s parsing functions (something to do with quotes or commas in the &quot;title&quot; field, I believe). The repaired <span class="caps">CSV</span> is saved with a <code>_out</code> prepended to the filename. Nothing fancy is required for the <code>read_csv</code> call in our&nbsp;case.</p>
<p>Now for the hard/interesting part. How do we map the flow of each image submission through the various&nbsp;subreddits?</p>
<ul>
<li>First we sort by image and (crucially) timetamp on line&nbsp;4.</li>
<li>On line 5, I simply extract the 3 columns that we care&nbsp;about. </li>
<li>Now we drop resubmissions of each image to the <em>same</em> subreddit with drop_duplicates on line 6, which only keeps each image&#39;s <em>first</em> submission to a particular subreddit (why we sorted&nbsp;first). </li>
<li>The last thing we need Pandas for is to group by image <span class="caps">ID</span> (line&nbsp;7).</li>
</ul>
<p>On line 7, we pull the list of subreddits (now unique and nicely ordered) for each image. The nested list comprehension is necessary only because calling <code>.subreddit</code> on the groupby object <code>g</code> returns a tuple by default, and we&#39;d rather have a list of&nbsp;lists.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[3]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="c"># Identify the order in which each image is submitted to various subreddits, </span>
<span class="c"># removing repeats within a subreddit</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s">&#39;#image_id&#39;</span><span class="p">,</span> <span class="s">&#39;unixtime&#39;</span><span class="p">])</span>\
     <span class="o">.</span><span class="n">ix</span><span class="p">[:,[</span><span class="s">&#39;#image_id&#39;</span><span class="p">,</span> <span class="s">&#39;unixtime&#39;</span><span class="p">,</span> <span class="s">&#39;subreddit&#39;</span><span class="p">]]</span>\
     <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;#image_id&#39;</span><span class="p">,</span> <span class="s">&#39;subreddit&#39;</span><span class="p">])</span>\
     <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">&#39;#image_id&#39;</span><span class="p">)</span>
<span class="n">flow</span> <span class="o">=</span> <span class="p">[[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">subreddit</span><span class="p">)]</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we need a function <code>window</code> that rolls along each of the lists in <code>flow</code> and connects every subsequent pair of subreddits that a particular image was submitted to. We&#39;ll do this with the help of the wonderful <code>itertools</code> module, creating two dimensional tuples that encode the &quot;from&quot; subreddit and the &quot;to&quot; subreddit, respectively. In lines 14 and 15, we apply the function and flatten the result to a single&nbsp;list.</p>
<p>In order to truly capture the &quot;flow,&quot; however, we need to distinguish between the &quot;gifs&quot; subreddit node where images are popping up for the first time and the &quot;gifs&quot; subreddit node when the image has already appeared in another subreddit (say, &quot;pics&quot;). The <code>enumerate</code> in line 14 does this by tacking on the ordinality to the name of the node, admittedly very hacky, but we have a lot of tuples floating around&nbsp;already.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[4]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="c"># Roll along the list of subreddits each image has been submitted to, </span>
<span class="c"># creating an edge tuple for each subsequent pair</span>
<span class="k">def</span> <span class="nf">window</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns a sliding window (of width n) over data from the iterable</span>
<span class="sd">       s -&gt; (s0,s1,...s[n-1]), (s1,s2,...,sn), ...&#39;&#39;&#39;</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">result</span>    
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="n">elem</span><span class="p">,)</span>
        <span class="k">yield</span> <span class="n">result</span>

<span class="n">sankey</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">window</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub</span><span class="p">)]))</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">]</span>
<span class="n">sankey</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">sankey</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span> <span class="c"># flatten</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At last we have a list of edges that on some level describes the flow that we are trying to get at. Now we can just iterate through them and use <code>NetworkX</code> to create the graph and weight the edges appropriately. In lines 10&#8212;13, I prune back the tiny edges that clutter up the diagram, and then the nodes that are no longer associated with any edges. Last but not least, we export the structure to a <span class="caps">JSON</span> in line&nbsp;16.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[5]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="c"># Create network structure</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">sankey</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">):</span>
        <span class="n">S</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s">&#39;weight&#39;</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        
<span class="c"># Trim edges</span>
<span class="n">S</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">])</span>
<span class="n">flagged</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;3&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">el</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
<span class="n">S</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">flagged</span><span class="p">])</span>
<span class="n">S</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>

<span class="c"># Export</span>
<span class="n">json_graph</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;sankey.json&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Time for&nbsp;R!</p>
<p>We will need to make sure that <code>d3Network</code> is installed to the the instance of R that is used by IPython&#39;s <code>Rmagic</code> via <code>Rpy2</code>. It was a different for me (I think?) so if you are running something like this for the first time, include the lines that are commented&nbsp;out.</p>
<p>The <code>%%R</code> denotes block-level R magicks in IPython (<code>%R</code> will give you line-level&nbsp;magicks)</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[6]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">R</span>
<span class="c">#install.packages(&#39;devtools&#39;)</span>
<span class="c">#library(devtools)</span>
<span class="c">#devtools::install_github(&quot;christophergandrud/d3Network&quot;)</span>
<span class="n">library</span><span class="p">(</span><span class="n">d3Network</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is finally the point at which Christopher Gandrud&#39;s package simplifies everything for us. We simply read in the nodes and linkes (edges) from the <span class="caps">JSON</span> file (they get converted to two dataframes). Note that we have to strip the janky ordinality numbers that we tacked onto the node names (line 3). Now that different nodes have the same names, the package will even make sure that each subreddit node has the same color every time it&nbsp;appears!</p>
<p>The call to <code>d3Sankey</code> points to the the nodes dataframe, the links dataframe, the name of the sources/targets in the links dataframe, the name of the column that holds the link weights, and then some display configuration&nbsp;stuff.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[7]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">R</span>
<span class="n">nodes</span> <span class="o">&lt;-</span> <span class="n">JSONtoDF</span><span class="p">(</span><span class="nb">file</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="s">&#39;sankey.json&#39;</span><span class="p">),</span> <span class="n">array</span> <span class="o">=</span> <span class="s">&#39;nodes&#39;</span><span class="p">)</span>
<span class="n">nodes</span><span class="err">$</span><span class="nb">id</span> <span class="o">&lt;-</span> <span class="n">substring</span><span class="p">(</span><span class="n">nodes</span><span class="err">$</span><span class="nb">id</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">links</span> <span class="o">&lt;-</span> <span class="n">JSONtoDF</span><span class="p">(</span><span class="nb">file</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="s">&#39;sankey.json&#39;</span><span class="p">),</span> <span class="n">array</span> <span class="o">=</span> <span class="s">&#39;links&#39;</span><span class="p">)</span>
<span class="n">d3Sankey</span><span class="p">(</span><span class="n">Nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">Links</span> <span class="o">=</span> <span class="n">links</span><span class="p">,</span> <span class="n">Source</span> <span class="o">=</span> <span class="s">&#39;source&#39;</span><span class="p">,</span>
         <span class="n">Target</span> <span class="o">=</span> <span class="s">&#39;target&#39;</span><span class="p">,</span> <span class="n">Value</span> <span class="o">=</span> <span class="s">&#39;weight&#39;</span><span class="p">,</span> <span class="n">NodeID</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> 
         <span class="n">width</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
         <span class="n">standAlone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">iframe</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="s">&#39;../extra/sankey.html&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>


<div class="output_text output_subarea ">
<pre>
&lt;iframe src=&apos;../extra/sankey.html&apos; height=535 width=618&gt;&lt;/iframe&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can render the resulting iframe directly in our IPython notebook! Hover over edges for some nice brushing or click and drag the nodes to untangle a relationship you&#39;re interested&nbsp;in.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[8]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">HTML</span><span class="p">(</span><span class="s">&#39;&lt;iframe src=&quot;../extra/sankey.html&quot; height=540 width=700 frameBorder=&quot;0&quot;&gt;&lt;/iframe&gt;&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">
    Out[8]:</div>

<div class="output_html rendered_html output_subarea output_pyout">
<iframe src="../extra/sankey.html" height=540 width=700 frameBorder="0"></iframe>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This type of &quot;tiered&quot; Sankey diagram is a little unconventional, but so far its the best way I can come up with to visualize the interesting phenomenon of submisison flow through Reddit. Leave a comment if this gives you any interesting ideas, I&#39;d love to hear&nbsp;them!</p>
</div>
</div>
</div></p>
                </div>
                <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'justmytwospence'; // required: replace example with your forum shortname
            var disqus_identifier = 'sankey';
            var disqus_url = 'http://spencerboucher.com/sankey/';
            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
            </article>
        </section>
    </div>

    </div>
</div>

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Spencer Boucher
            &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>, <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>, <a href="http://pages.github.com/" target="_blank">GitHub Pages</a>, and Viewers Like You         </div>
         <div class="col-xs-2"><a href="#" class="pull-right"><i class="fa fa-arrow-circle-up fa-lg"></i></a></div>
      </div>
   </div>
</footer>
<script src="http://code.jquery.com/jquery.js"></script>

<script src="http://spencerboucher.com/theme/js/dynamic.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://spencerboucher.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://spencerboucher.com/theme/js/respond.min.js"></script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'justmytwospence'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-45101202-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>


</body>

</html>